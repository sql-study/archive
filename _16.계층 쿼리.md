

# 계층 쿼리



***계층 쿼리를 사용하면 순환(recursive) 관계를 가진 데이터를 조회***



순환 관계를 가진 데이터는 아래와 같은 계층 구조로 표현.

![image-20200328140726256](https://tva1.sinaimg.cn/large/00831rSTgy1gd9k8w4gy8j31bg0lmaom.jpg)



노드는 3가지로 구분할 수 있음.

**루트 노드** - 부모 노드가 존재하지 않는 노드

**브랜치 노드** - 부모 노드와 자식 노드가 존재하는 노드

**리프 노드** - 자식 노드가 존재하지 않는 노드



순환 관계는 계층의 깊이에 따라 레벨(level)이 부여.



이제 쿼리를 조회해보자.

![image-20200328143102973](https://tva1.sinaimg.cn/large/00831rSTgy1gd9kxe4uc0j31ba0gqwoz.jpg)



```sql
SELECT b.empno, b.ename, b.mgr FROM emp a, emp b
WHERE a.ename = 'JONES' AND b.mgr=a.empno;
```

![image-20200328143211038](https://tva1.sinaimg.cn/large/00831rSTgy1gd9kyjpuccj30j806u0t6.jpg)



이제 위 쿼리에서 자식 노드를 조회해볼까?

```sql
SELECT c.empno, c.ename, c.mgr
FROM emp a, emp b, emp c
WHERE a.ename ='JONES' 
AND b.mgr=a.empno 
AND c.mgr = b.empno;
```

![image-20200328143400198](https://tva1.sinaimg.cn/large/00831rSTgy1gd9l0g7ec4j30km07w0t8.jpg)



부모를 조회하자.

```sql
SELECT b.empno, b.ename, b.mgr
FROM emp a, emp b
WHERE a.ename = 'SMITH'
AND b.empno = a.mgr;

-- FORD가 나올 예정.
```



*깊은 레벨의 노드를 조회하기 위해서는 셀프 조인을 반복해야 한다.*



오라클에서는 셀프조인이 아닌, 

순환 관계를 가진 데이터를 조회할 수 있는 **계층 쿼리 절**과 **재귀 서브 쿼리 팩토링** 기능을 제공



## 1. 계층 쿼리 절

WHERE 절 다음에 기술하며, FROM 절이 수행된 후 수행.

START WITH절과 CONNECT BY 절로 구성되며, START WITH절이 수행된 후 CONNECT BY절이 수행. START WITH절은 생략 가능

`[START WITH condition] CONNECT BY [NOCYCLE] condition`



`START WITH 절` - 루트 노드를 생성하며 1번만 수행

`CONNECT BY 절 `- 루트 노드의 하위 노드를 생성하여 조회 결과가 없을 때까지 반복 수행



![image-20200328145428143](https://tva1.sinaimg.cn/large/00831rSTgy1gd9lls67ryj31c60j4qm7.jpg)



`START WITH` 절로 mgr가 존재하지 않는 행을 조회하고, `CONNECT BY`절로 현재 노드의 mgr가 직전 상위 노드의 empno인 행을 반복 조회.

ename 열은 `LEVEL 슈도 칼럼`과 `LPAD 함수`를 사용하여 계층의 레벨에 따라 값을 들여쓰기.



```sql
SELECT  LEVEL AS lv, empno, LPAD(' ', LEVEL -1, ' ') || ename AS ename, mgr, PRIOR empno AS empno_p
FROM emp
START WITH mgr IS NULL
CONNECT BY mgr = PRIOR empno;
```

![image-20200328145907539](https://tva1.sinaimg.cn/large/00831rSTgy1gd9lqp2qdhj313f0u04qp.jpg)





**SYS_CONNECT_BY_PATH 함수**

*루트 노드에서 현재 노드까지의 column을 char로 구분하여 연결한 값을 반환.*

- column 값에 char가 포함되어 있으면 ORA-30004 에러 발생

- 연결한 값의 길이가 4000보다 길면 ORA-01489 에러 발생

`SYS_CONNECT_BY_PATH(column, char)`



![image-20200328150816637](https://tva1.sinaimg.cn/large/00831rSTgy1gd9m05s7ifj31d80s61g1.jpg)



### 계층 쿼리절의 동작 원리

계층 쿼리 절은 `START WITH 절 ` 로 루트 노드를 생성한 후, 결과가 없을 때까지 CONNECT 절을 반복 수행하여 하위 노드를 생성



| 1단계(LEVEL = 1)

- START WITH 절을 수행하여 루트 노드를 생성.
- START WITH절은 WHERE 절과 유사하게 동작  
  `SELECT 1 AS lv, empno, ename, mgr FROM emp WHERE mgr IS NULL `
- 결과를 임시테이블에 저장

| 2단계(LEVEL = 2)

- CONNECT BY 절은 임시 테이블에 저장된 1단계 결과와 emp 테이블을 조인. CONNECT BY  절도 WHERE 절과 유사하게 동작  

```sql
SELECT 2 AS lv, c.empno, c.ename, c.mgr 
FROM t1 p, emp c WHERE p.lv = 1

AND c.mgr=p.empno -- CONNECT BY mgr = PRIOR empno
```

- 결과를 임시테이블에 저장



| 3단계(LEVEL =3)

- CONNECT BY 절로 임시 테이블에 저장된 2단계 결과와 emp 테이블을 조인

```sql
SELECT 3 AS lv, c.empno, c.ename, c.mgr
FROM t1 p, emp c -- 여기서 t1은 임시 테이블
WHERE p.lv = 2
AND c.mgr = p.empno;
```

- 결과를 마찬가지로 임시테이블에 저장

| 4단계(LEVEL=4)

- CONNECT BY 절로 임시 테이블에 저장된 3단계 결과와 emp 테이블을 조인

```sql
SELECT 4 AS lv, c.empno, c.ename, c.mgr
FROM t1 p, emp c
WHERE p.lv = 3
AND c.mgr = p.empno;
```

- 결과를 마찬가지로 임시테이블 저장



| 5단계(LEVEL=5)

- CONNECT BY 절로 임시 테이블에 저장된 4단계 결과와 emp 테이블을 조인

```sql
SELECT 5 AS lv, c.empno, c.ename, c.mgr
FROM t1 p, emp c
WHERE p.lv = 4
AND c.mgr = p.empno;

-- 선택된 레코드가 없습니다.
```

결과가 반환되지 않으면 CONNECT BY 절의 수행을 멈추고 수행 결과가 저장된 임시 테이블을 조회하여 결과를 반환.



### 계층 쿼리의 전개 방향

순환 관계는 순방향 또는 역방향으로 전개.

![image-20200328152205576](https://tva1.sinaimg.cn/large/00831rSTgy1gd9mem05woj316r0u01kx.jpg)



![image-20200328152323934](https://tva1.sinaimg.cn/large/00831rSTgy1gd9mfvebumj31d40n84go.jpg)



### 계층 정렬

형제 노드의 정렬을 위해 SIBLINGS 키워드를 제공

**계층 쿼리 절에 ORDER BY 절을 사용하면 계층 구조와 무관하게 행이 정렬**

```sql
SELECT LEVEL AS lv, empno, LPAD(' ', LEVEL-1, ' ') || ename AS ename, mgr, sal
FROM emp
START WITH mgr IS NULL
CONNECT BY mgr = PRIOR empno
ORDER BY sal;
```



그러므로 잘 정렬하기 위해서는 형제 노드 내에서만 정렬되기 위한다면 `SIBLINGS` 키워드 사용

![image-20200328153044677](https://tva1.sinaimg.cn/large/00831rSTgy1gd9mni7sp5j31c40fqdpr.jpg)



### 계층 구조의 루프 처리

- 부모 노드가 현재 노드의 자식 노드로 연결되면 루프(loop)가 발생.
- 계층 쿼리 절은 루프 처리를 위해 `NOCYCLE` 키워드와 `CONNECT_BY_ISCYCLE` 슈도 칼럼 제공

![image-20200328153419299](https://tva1.sinaimg.cn/large/00831rSTgy1gd9mr8apvzj31fi0u0e1l.jpg)



# 재귀 서브 쿼리 팩토링

11.2 부터 사용 가능.

계층 쿼리 절보다 복잡하지만 다양한 기능 사용.



- **재귀 서브 쿼리 팩토링은 WITH 절 사용** 
- 재귀 서브 쿼리 팩토링은 WITH 절은 서브 쿼리
- SEARCH 절, CYCLE 절로 구성

![image-20200328153641979](https://tva1.sinaimg.cn/large/00831rSTgy1gd9mtpen3wj31co0citlx.jpg)



어려버...



# 활용 예제



## 순번 생성

계층 쿼리를 사용하여 순번을 가진 테이블을 생성. 행 복제 시 해당 기법을 활용

`SELECT LEVEL AS lv FROM DUAL CONNECY BY LEVEL <= 100;`

